{% extends "base/layout.html" %}
{% from 'base/components/forms.html' import field %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 fw-bold">Configuração de Categorias</h2>
        <p class="text-muted mb-0">Gerencie Categorias de Receita e Categorias de Despesa.</p>
    </div>
</div>

<div class="row g-4">
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                <h5 class="fw-bold mb-0"><i class="bi bi-tags text-success me-2"></i>Categorias de Receita</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('financeiro.add_revenue_category') }}">
                    {{ form_revenue.hidden_tag() }}
                    {{ field(form_revenue.name, placeholder="Ex: Salário, Freelance, Investimentos") }}
                    <button type="submit" class="btn btn-success w-100 mt-2">
                        Salvar Categoria de Receita
                    </button>
                </form>
                
                <h6 class="mt-4 mb-3 text-muted">Categorias Cadastradas ({{ categories|length }})</h6>
                <div class="list-group list-group-flush border-top">
                    {% for category in categories %}
                        <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                            <span class="fw-medium text-success">{{ category.name }} ({{ category.transactions.count() }} entradas)</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-link text-muted p-0 me-2" data-bs-toggle="modal" data-bs-target="#editCategoryModal{{ category.id }}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{ url_for('financeiro.delete_revenue_category', category_id=category.id) }}" onsubmit="return confirm('Tem certeza? A exclusão só é permitida se não houver transações ligadas.');" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% set form = form_revenue %} 
                        {% include 'financeiro/category_modal.html' %}
                        {% set form = none %}
                    {% else %}
                        <p class="text-muted small mt-2">Nenhuma categoria de Receita cadastrada.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                <h5 class="fw-bold mb-0"><i class="bi bi-journal-text text-danger me-2"></i>Categorias de Despesa</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('financeiro.add_expense_category') }}">
                    {{ form_expense.hidden_tag() }}
                    {{ field(form_expense.name, placeholder="Ex: Aluguel, Supermercado, Streaming") }}
                    <button type="submit" class="btn btn-danger w-100 mt-2">Salvar Categoria</button>
                </form>

                <h6 class="mt-4 mb-3 text-muted">Categorias Cadastradas ({{ expense_categories|length }})</h6>
                <div class="list-group list-group-flush border-top">
                    {% for category in expense_categories %}
                        <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                            <span class="fw-medium">{{ category.name }} ({{ category.expenses.count() }} despesas)</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-link text-muted p-0 me-2" data-bs-toggle="modal" data-bs-target="#editExpenseCategoryModal{{ category.id }}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{ url_for('financeiro.delete_expense_category', category_id=category.id) }}" onsubmit="return confirm('Tem certeza? A exclusão só é permitida se não houver despesas ligadas.');" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="modal fade" id="editExpenseCategoryModal{{ category.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content border-0 shadow">
                                    <div class="modal-header border-0 pb-0">
                                        <h5 class="modal-title fw-bold text-danger">Editar Categoria: {{ category.name }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('financeiro.manage_expense_category', category_id=category.id) }}">
                                        {{ form_expense.hidden_tag() }}
                                        <div class="modal-body pt-4">
                                            {{ field(form_expense.name, value=category.name, placeholder="Nome da Categoria de Despesa") }}
                                        </div>
                                        <div class="modal-footer border-0 pt-0">
                                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-danger px-4">Salvar Alterações</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted small mt-2">Nenhuma categoria de Despesa cadastrada.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% extends "base/layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="fw-bold text-dark">Visão Geral</h2>
    <p class="text-muted">Acompanhe a evolução do seu patrimônio e fluxo de caixa.</p>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-success bg-opacity-10 p-3 rounded-4">
                        <i class="bi bi-arrow-up-right text-success fs-4"></i>
                    </div>
                    <span class="badge bg-success rounded-pill">+ Entradas</span>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Receitas Totais</h6>
                <h3 class="fw-bold text-success mb-0">{{ total_revenues | currency }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-4">
                        <i class="bi bi-arrow-down-left text-danger fs-4"></i>
                    </div>
                    <span class="badge bg-danger rounded-pill">- Saídas</span>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Despesas Totais</h6>
                <h3 class="fw-bold text-danger mb-0">{{ total_expenses | currency }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 h-100 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-white bg-opacity-25 p-3 rounded-4">
                        <i class="bi bi-wallet2 text-white fs-4"></i>
                    </div>
                    <span class="badge bg-white text-primary rounded-pill">Resultado</span>
                </div>
                <h6 class="text-white text-opacity-75 text-uppercase small fw-bold">Saldo Acumulado</h6>
                <h3 class="fw-bold text-white mb-0">{{ balance | currency }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-70 mb-4">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-success"><i class="bi bi-calendar-check me-2"></i>A Receber</h5>
                <a href="{{ url_for('financeiro.revenues') }}" class="btn btn-sm btn-light rounded-pill">Ver tudo</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for r in next_revenues %}
                        {# Lógica de Cores e Badges para Receita #}
                        {% set days = (r.due_date - now_date).days %}
                        {% if days < 0 %}
                            {% set box_class = "bg-danger bg-opacity-10 text-danger" %}
                            {% set text_class = "text-danger" %}
                            {% set badge = '<span class="badge bg-danger ms-2">Atrasado</span>' %}
                        {% elif days == 0 %}
                            {% set box_class = "bg-success text-white shadow-sm" %}
                            {% set text_class = "text-success" %}
                            {% set badge = '<span class="badge bg-success ms-2">Hoje!</span>' %}
                        {% else %}
                            {% set box_class = "bg-success bg-opacity-10 text-success" %}
                            {% set text_class = "text-dark" %}
                            {% set badge = '' %}
                        {% endif %}

                    <div class="list-group-item border-0 d-flex justify-content-between align-items-center px-4 py-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="{{ box_class }} rounded-3 p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <span class="fw-bold small">{{ r.due_date.day }}</span>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold {{ text_class }}">
                                    {{ r.description }} {{ badge|safe }}
                                </h6>
                                <small class="text-muted">{{ r.category.name }}</small>
                            </div>
                        </div>
                        <span class="fw-bold text-success text-nowrap">+ {{ r.amount | currency }}</span>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted small">Nada a receber em breve.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-70 mb-4">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-danger"><i class="bi bi-exclamation-circle me-2"></i>A Pagar</h5>
                <a href="{{ url_for('financeiro.expenses') }}" class="btn btn-sm btn-light rounded-pill">Ver tudo</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for e in next_expenses %}
                        {# Lógica de Cores e Badges para Despesa #}
                        {% set days = (e.due_date - now_date).days %}
                        
                        {% if days < 0 %}
                            {% set box_class = "bg-danger text-white shadow-sm" %}
                            {% set text_class = "text-danger" %}
                            {% set badge = '<span class="badge bg-danger ms-2">Dias em atraso: ' ~ days|abs ~ '</span>' %}
                        
                        {% elif days == 0 %}
                            {# Vence Hoje: Amarelo/Laranja #}
                            {% set box_class = "bg-warning text-dark shadow-sm" %}
                            {% set text_class = "text-dark" %}
                            {% set badge = '<span class="badge bg-warning text-dark ms-2">Vence Hoje!</span>' %}
                        
                        {% else %}
                            {# Futuro: Normal #}
                            {% set box_class = "bg-danger bg-opacity-10 text-danger" %}
                            {% set text_class = "text-dark" %}
                            {% set badge = '' %}
                        {% endif %}

                    <div class="list-group-item border-0 d-flex justify-content-between align-items-center px-4 py-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="{{ box_class }} rounded-3 p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <span class="fw-bold small">{{ e.due_date.day }}</span>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold {{ text_class }}">
                                    {{ e.description }} {{ badge|safe }}
                                </h6>
                                <small class="text-muted">{{ e.category.name }}</small>
                            </div>
                        </div>
                        <span class="fw-bold text-danger text-nowrap">- {{ e.amount | currency }}</span>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted small">Nenhuma conta pendente.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
        <h5 class="fw-bold mb-0">Fluxo de Caixa (6 Meses)</h5>
        <small class="text-muted">Histórico realizado vs. Previsão futura.</small>
    </div>
    <div class="card-body px-4 pb-4">
        <div style="height: 300px;">
            <canvas id="cashFlowChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h5 class="fw-bold mb-0">Fontes de Receita (Ano)</h5>
            </div>
            <div class="card-body d-flex justify-content-center" style="height: 250px;">
                <canvas id="revenueCategoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h5 class="fw-bold mb-0">Gastos por Categoria (Ano)</h5>
            </div>
            <div class="card-body d-flex justify-content-center" style="height: 250px;">
                <canvas id="expenseCategoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. Gráfico de Fluxo de Caixa (Linha/Barra) ---
    const ctxFlow = document.getElementById('cashFlowChart').getContext('2d');
    const flowData = {{ chart_data | tojson }};
    
    // Plugin da linha "Hoje"
    const todayPlugin = {
        id: 'todayLine',
        beforeDraw: (chart) => {
            if (chart.tooltip._active && chart.tooltip._active.length) return;
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            const x = xAxis.getPixelForTick(5);
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, yAxis.top);
            ctx.lineTo(x, yAxis.bottom);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.restore();
        }
    };

    new Chart(ctxFlow, {
        type: 'bar',
        data: {
            labels: flowData.labels,
            datasets: [
                {
                    label: 'Saldo',
                    data: flowData.balances,
                    type: 'line',
                    borderColor: '#0d6efd',
                    backgroundColor: '#0d6efd',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3,
                    order: 0
                },
                {
                    label: 'Receitas',
                    data: flowData.revenues,
                    backgroundColor: 'rgba(25, 135, 84, 0.7)',
                    borderRadius: 4,
                    order: 1
                },
                {
                    label: 'Despesas',
                    data: flowData.expenses,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderRadius: 4,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top', align: 'end' } },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2, 2], drawBorder: false } },
                x: { grid: { display: false } }
            }
        },
        plugins: [todayPlugin]
    });

    // --- 2. Dados de Categorias ---
    const catData = {{ category_data | tojson }};
    const commonDoughnutOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
        },
        layout: { padding: 10 }
    };
    
    const colors = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
        '#858796', '#5a5c69', '#f8f9fc', '#6610f2', '#fd7e14'
    ];

    if (catData.revenue_values.length > 0) {
        new Chart(document.getElementById('revenueCategoryChart'), {
            type: 'doughnut',
            data: {
                labels: catData.revenue_labels,
                datasets: [{
                    data: catData.revenue_values,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: commonDoughnutOptions
        });
    } else {
        document.getElementById('revenueCategoryChart').parentElement.innerHTML = '<p class="text-muted small my-auto">Sem dados este ano.</p>';
    }

    if (catData.expense_values.length > 0) {
        new Chart(document.getElementById('expenseCategoryChart'), {
            type: 'doughnut',
            data: {
                labels: catData.expense_labels,
                datasets: [{
                    data: catData.expense_values,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: commonDoughnutOptions
        });
    } else {
        document.getElementById('expenseCategoryChart').parentElement.innerHTML = '<p class="text-muted small my-auto">Sem dados este ano.</p>';
    }
});
</script>
{% endblock %}
